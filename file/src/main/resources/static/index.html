<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>


<form id="fileupload" action="" method="POST" enctype="multipart/form-data">
    <div>
        <div>
            添加文件
            <input type="file" name="" id="fileinput">
        </div>

        <progress class='progressbar' value="0" max="100" style='width:500px;margin-top:20px'></progress>
        <div style='margin-top:20px'>
            <span id="handler_info" ></span>
        </div>
    </div>
</form>
<script src="js/spark-md5.min.js" type="text/javascript"></script>
<script src="js/main.js" type="text/javascript"></script>
<script>
    function get_filemd5sum(ofile) {
        var file = ofile;
        var tmp_md5;
        var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
            // file = this.files[0],
            chunkSize = 8097152, // Read in chunks of 2MB
            chunks = Math.ceil(file.size / chunkSize),
            currentChunk = 0,
            spark = new SparkMD5.ArrayBuffer(),
            fileReader = new FileReader();

        fileReader.onload = function(e) {
            // console.log('read chunk nr', currentChunk + 1, 'of', chunks);
            spark.append(e.target.result); // Append array buffer
            currentChunk++;
            var md5_progress = Math.floor((currentChunk / chunks) * 100);

            console.log(file.name + "  正在处理，请稍等," + "已完成" + md5_progress + "%");
            var handler_info = document.getElementById("handler_info");
            var progressbar = document.getElementsByClassName("progressbar")[0];
            handler_info.innerHTML=file.name + "  正在处理，请稍等," + "已完成" + md5_progress + "%"
            progressbar.value =md5_progress;
            if (currentChunk < chunks) {
                loadNext();
            } else {
                tmp_md5 = spark.end();
                console.log(tmp_md5)
                handler_info.innerHTML = file.name + "的MD5值是：" + tmp_md5;
            }
        };
        fileReader.onerror = function() {
            console.warn('oops, something went wrong.');
        };
        function loadNext() {
            var start = currentChunk * chunkSize,
                end = ((start + chunkSize) >= file.size) ? file.size : start + chunkSize;
            fileReader.readAsArrayBuffer(blobSlice.call(file, start, end));
        }
        loadNext();
    }
    var uploadfile  = document.getElementById('fileinput')
    uploadfile.onchange = function(e){
        var file = this.files[0];
        if(!file) {
            alert('请选择文件！');
            return false;
        }
        get_filemd5sum(file)
    }
</script>

<hr/>

<h1>图片MD5验证</h1>
<form>
    MD5：<input type="text" name="imageMd5" id="id-md5"><br/>
    <input type="button" value="请求"  onclick="port('http://localhost:8080/images/contrast',document.getElementById('id-md5').value,'id-div')">
    <div id="id-div"></div>
</form>
<hr/>
<h1>图片上传</h1>
<form method="post" action="/images/upload" enctype="multipart/form-data">
    文件：<input name="file" type="file"><br/>
    阶段：<input type="text" name="cont"><br/>
    MD5：<input type="text" name="imageMd5"><br/>
    标签：<input type="text" name="label"><br/>
    <input type="submit">
</form>
</body>
</html>